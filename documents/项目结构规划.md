# 项目结构规划（含MVP时期）

## 顶层结构
- 仓库采用前后端分离 + 共享类型的双包结构：
```
logistics-platform/
  frontend/               # React + TS + Redux Toolkit + RTK Query + Ant Design
  backend/                # Express + TS + Socket.IO（REST + WebSocket）
  shared/                 # 跨端共享类型、常量与事件载荷
  REQDOC.md               # 项目需求
  .trae/documents/        # 项目文档
```

## 环境与脚本
- 环境变量：
  - 前端：`FRONTEND_DEV_API_URL`、`FRONTEND_DEV_WS_URL`、`AMAP_KEY`、`MAP_PROVIDER=amap`
  - 后端：`PORT`、`WS_PATH=/ws`、`PUSH_INTERVAL_MS=500..1000`、`ROUTE_PRESET_ID`
- NPM脚本（顶层/各包）：
  - `frontend:dev`、`frontend:build`
  - `backend:dev`、`backend:start`
  - `lint`、`test`

## Frontend 结构规划
- 技术栈：React + TypeScript；状态管理 `Redux Toolkit`；数据获取 `RTK Query`；UI `Ant Design`
- 目录布局：
```
frontend/src/
  app/
    store.ts              # 配置RTK与中间件
    providers.tsx         # Store/Theme/Router注入
  routes/
    index.tsx             # 路由：/merchant、/orders/:id、/tracking
  pages/
    MerchantDashboard/    # 订单列表筛选/排序、跳转详情
    OrderDetail/          # 订单详情与“发货”按钮
    TrackingSearch/       # 输入订单号、查询并订阅实时推送
  features/
    orders/
      orders.api.ts       # GET /api/orders、GET /api/orders/:id、POST /ship
      orders.slice.ts     # 列表筛选状态 pending|in_transit|signed
    tracking/
      tracking.slice.ts   # 当前坐标、ETA、时间线
      tracking.selectors.ts
  services/
    socket/socketClient.ts # Socket.IO封装：心跳/重连/订阅恢复
    map/MapAdapter.ts      # 抽象适配接口
    map/adapters/amap.ts   # 高德地图实现
  components/
    TrackingMap.tsx       # 地图渲染（车辆图标+polyline+当前点）
    Timeline.tsx          # 时间线（picked→in_transit→out_for_delivery→signed）
  utils/
    interpolate.ts        # 线性插值与动画帧节流
    format.ts             # 金额/时间格式化
  types/
    index.ts              # 从shared引入统一类型
```
- 关键交互：
  - `TrackingSearch` 成功查询后执行 `socketClient.subscribe(orderId)`；`TrackingMap` 对 `track:update` 做插值动画；`Timeline`依据 `order:status` 更新。
- 枚举与术语：
  - 列表筛选枚举统一为 `pending | in_transit | signed`
  - 时间线状态：`picked | in_transit | out_for_delivery | signed`
- 性能与可靠性：
  - 地图保留最近 N 点（如500），轨迹分段绘制；`requestAnimationFrame` 控制平滑移动。
  - 断线重连后自动恢复订阅；服务端回放最近队列补齐。

## Backend 结构规划
- 技术栈：Express + TypeScript；实时通信 Socket.IO；分层架构（路由/控制器/服务/数据访问）
- 目录布局：
```
backend/src/
  app.ts                  # 初始化HTTP与Socket.IO，中间件与CORS
  config/
    env.ts                # 环境变量解析
    routes.ts             # 预置路线选择参数
  routes/
    orders.routes.ts      # /api/orders* 路由定义
  controllers/
    orders.controller.ts  # 入参校验与响应包装
  services/
    orders.service.ts     # 列表/详情/发货状态流转
    tracking.service.ts   # 轨迹与时间线查询
    trajectory.simulator.ts # 轨迹模拟与定时推送
  ws/
    socket.server.ts      # 事件通道：track:update、order:status；心跳与订阅恢复
  dal/
    memory.repository.ts  # MVP内存存储
    sqlite.repository.ts  # 可选：后续升级
  models/
    order.ts, trackPoint.ts, shipmentState.ts
  middleware/
    errorHandler.ts       # 统一错误输出 {data:null,error:{code,message}}
  utils/
    eta.ts                # 简化ETA估算
```
- REST API：
  - `GET /api/orders?status=&sort=&order=` 列表筛选/排序
  - `GET /api/orders/:id` 详情
  - `POST /api/orders/:id/ship` 发货并启动模拟器
  - `GET /api/orders/:id/tracking` 初始轨迹数据
- WebSocket事件：
  - `track:update` `{orderId, lat, lng, ts, speed, remainingDistance}`
  - `order:status` `{orderId, status, ts}`（`picked | in_transit | out_for_delivery | signed`）
- 轨迹模拟：
  - 选择预置路线，以 `500–1000ms` 推送下一个点；终点触发 `signed`。
  - 可配置：`PUSH_INTERVAL_MS`、`MAX_RECENT_POINTS`、`AVG_SPEED`。
- 可靠性与性能：
  - 心跳与重连；订阅恢复后回放最近M点（如100）。
  - 高频推送下聚合批次避免过载；`ts` 单调递增保证顺序。

## Shared（共享类型与协议）
- 目录：`shared/src/types.ts`、`shared/src/constants.ts`
- 类型：`Order`、`TrackPoint`、`ShipmentState`、事件载荷（`TrackUpdatePayload`、`OrderStatusPayload`）
- 状态词典与映射：`signed ≡ delivered ≡ 已签收/已完成`；前后端统一引用。

## MVP时期的结构规划（最小闭环）
- 前端包含：
  - 页面：`MerchantDashboard`、`OrderDetail`、`TrackingSearch`
  - 组件：`TrackingMap`、`Timeline`
  - 领域：`orders.api.ts`（查询/发货）、`tracking.slice.ts`（坐标/时间线）
  - 实时：`socketClient.ts`、`amap` 适配与基础动画插值
- 后端包含：
  - REST：`GET /orders*`、`POST /ship`、`GET /tracking`
  - WebSocket：`track:update` 与 `order:status`
  - 模拟器：预置路线推送与终态`signed`
  - 存储：内存版（可切换至SQLite）
- 排除项（移动到功能完善阶段）：
  - 配送范围圈选、时效设置与筛选
  - 订单完整CRUD（创建/更新/删除）
  - 数据看板与路线规划接入

## 测试与验收
- 单测（backend）：轨迹迭代、终态签收、ETA计算；服务层状态流转与筛选。
- 集成（端到端）：发货→推送→订阅→地图更新→时间线更新闭环；断线重连回放正确。
- 前端测试：slice/selectors/组件渲染及动画插值基本断言。
- 验收基线：200订单、500–1000ms推送周期无明显掉帧；UI术语与接口枚举一致。

## 与REQDOC的对齐
- 覆盖：商家端列表/详情/发货、用户查询/地图追踪/时间线、后端REST与WebSocket、轨迹模拟、性能与实时数据处理。
- 加分项安排：数据看板与路线规划在完善/优化阶段执行。

